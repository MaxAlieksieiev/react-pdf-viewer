"use strict";var e=require("react/jsx-runtime"),t=require("@react-pdf-viewer/core");function n(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var i=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,i.get?i:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var i,a=n(require("react"));exports.ThumbnailDirection=void 0,(i=exports.ThumbnailDirection||(exports.ThumbnailDirection={})).Horizontal="Horizontal",i.Vertical="Vertical";var r=function(){return r=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e},r.apply(this,arguments)};"function"==typeof SuppressedError&&SuppressedError;var o=function(n){var i=n.doc,r=n.getPageIndex,o=n.renderSpinner,u=n.store,c=n.width,s=i.numPages,l=r?r({numPages:s}):0,d=Math.max(0,Math.min(l,s-1)),g=u.get("pagesRotation")||new Map,h=g.has(d)?g.get(d):0,p=a.useState(""),b=p[0],m=p[1],f=t.useIsMounted(),v=a.useRef(),_=a.useState(u.get("rotation")||0),x=_[0],P=_[1],w=a.useState(h),R=w[0],S=w[1],C=a.useState(!1),j=C[0],M=C[1],I=function(e){var t=e.has(d)?e.get(d):0;S(t)},V=function(e){P(e)},D=t.useIntersectionObserver({onVisibilityChanged:function(e){M(e.isVisible)}});return a.useEffect((function(){if(j){var e=D.current;e&&(m(""),t.getPage(i,d).then((function(t){var n=t.getViewport({scale:1}),i=(n.rotation+x+R)%360,a=Math.abs(x+R)%180==0,r=a?n.width:n.height,o=a?n.height:n.width,u=document.createElement("canvas"),s=u.getContext("2d",{alpha:!1}),l=e.clientWidth,d=e.clientHeight,g=c?c/r:Math.min(l/r,d/o),h=g*r,p=g*o;u.height=p,u.width=h,u.style.opacity="0";var b=t.getViewport({rotation:i,scale:g});v.current=t.render({canvasContext:s,viewport:b}),v.current.promise.then((function(){f.current&&m(u.toDataURL()),u.width=0,u.height=0}),(function(){}))})))}}),[R,j]),a.useEffect((function(){return u.subscribe("pagesRotation",I),u.subscribe("rotation",V),function(){u.unsubscribe("pagesRotation",I),u.unsubscribe("rotation",V)}}),[]),a.useEffect((function(){return function(){var e;null===(e=v.current)||void 0===e||e.cancel()}}),[]),e.jsx("div",{ref:D,className:"rpv-thumbnail__cover-inner","data-testid":"thumbnail__cover-inner",children:b?e.jsx("img",{className:"rpv-thumbnail__cover-image","data-testid":"thumbnail__cover-image",src:b}):e.jsx("div",{className:"rpv-thumbnail__cover-loader","data-testid":"thumbnail__cover-loader",children:o?o():e.jsx(t.Spinner,{})})})},u=function(n){var i=n.getPageIndex,r=n.renderSpinner,u=n.store,c=n.width,s=a.useState(u.get("doc")),l=s[0],d=s[1],g=function(e){d(e)};return a.useEffect((function(){return u.subscribe("doc",g),function(){u.unsubscribe("doc",g)}}),[]),e.jsx("div",{className:"rpv-thumbnail__cover",children:l?e.jsx(o,{doc:l,getPageIndex:i,renderSpinner:r,store:u,width:c}):e.jsx("div",{className:"rpv-thumbnail__cover-loader",children:r?r():e.jsx(t.Spinner,{})})})},c=function(){return e.jsx(t.Spinner,{})},s=a.createContext({renderSpinner:c}),l=function(n){var i=n.children,r=n.doc,o=t.useIsMounted(),u=a.useState({loading:!0,labels:[]}),c=u[0],s=u[1];return a.useEffect((function(){r.getPageLabels().then((function(e){o.current&&s({loading:!1,labels:e||[]})}))}),[r.loadingTask.docId]),c.loading?e.jsx(e.Fragment,{}):i(c.labels)},d=function(n){var i=n.page,r=n.pageHeight,o=n.pageIndex,u=n.pageWidth,c=n.rotation,l=n.thumbnailHeight,d=n.thumbnailWidth,g=n.onRenderCompleted,h=a.useContext(t.LocalizationContext).l10n,p=a.useRef(),b=a.useState(""),m=b[0],f=b[1],v=h&&h.thumbnail?h.thumbnail.thumbnailLabel:"Thumbnail of page {{pageIndex}}";return a.useEffect((function(){var e=p.current;e&&e.cancel();var t=document.createElement("canvas"),n=t.getContext("2d",{alpha:!1}),a=d,s=a/(u/r),l=a/u;t.height=s,t.width=a,t.style.height="".concat(s,"px"),t.style.width="".concat(a,"px");var h=i.getViewport({rotation:c,scale:l});return p.current=i.render({canvasContext:n,viewport:h}),p.current.promise.then((function(){f(t.toDataURL()),g(o)}),(function(){g(o)})),function(){var e;null===(e=p.current)||void 0===e||e.cancel()}}),[c]),m?e.jsx("img",{"aria-label":v.replace("{{pageIndex}}","".concat(o+1)),src:m,height:"".concat(l,"px"),width:"".concat(d,"px")}):a.useContext(s).renderSpinner()},g=function(n){var i=n.doc,r=n.pageHeight,o=n.pageIndex,u=n.pageRotation,c=n.pageWidth,l=n.rotation,g=n.shouldRender,h=n.thumbnailWidth,p=n.onRenderCompleted,b=n.onVisibilityChanged,m=t.useIsMounted(),f=a.useState({height:r,page:null,viewportRotation:0,width:c}),v=f[0],_=f[1],x=v.page,P=v.height,w=v.width,R=w/P,S=Math.abs(l+u)%180==0,C=S?h:h/R,j=S?h/R:h;a.useEffect((function(){g&&t.getPage(i,o).then((function(e){var t=e.getViewport({scale:1});m.current&&_({height:t.height,page:e,viewportRotation:t.rotation,width:t.width})}))}),[g]);var M=(v.viewportRotation+l+u)%360,I=t.useIntersectionObserver({onVisibilityChanged:function(e){b(o,e)}});return e.jsx("div",{className:"rpv-thumbnail__container","data-testid":"thumbnail__container-".concat(o),ref:I,style:{height:"".concat(j,"px"),width:"".concat(C,"px")},children:x?e.jsx(d,{page:x,pageHeight:S?P:w,pageIndex:o,pageWidth:S?w:P,rotation:M,thumbnailHeight:j,thumbnailWidth:C,onRenderCompleted:p}):a.useContext(s).renderSpinner()})},h=function(n){var i=n.currentPage,r=n.doc,o=n.labels,u=n.pagesRotation,c=n.pageHeight,s=n.pageWidth,l=n.renderCurrentPageLabel,d=n.renderThumbnailItem,h=n.rotatedPage,p=n.rotation,b=n.thumbnailDirection,m=n.thumbnailWidth,f=n.viewMode,v=n.onJumpToPage,_=n.onRotatePage,x=r.numPages,P=r.loadingTask.docId,w=a.useRef(null),R=a.useRef([]),S=a.useState(i),C=S[0],j=S[1],M=a.useContext(t.ThemeContext).direction===t.TextDirection.RightToLeft,I=a.useState(-1),V=I[0],D=I[1],T=t.useIsMounted(),y=t.usePrevious(f),W=a.useRef(!1),k=t.useRenderQueue({doc:r}),L=a.useMemo((function(){return Array(x).fill(0).map((function(e,t){return t}))}),[P]),E=a.useMemo((function(){switch(f){case t.ViewMode.DualPage:return t.chunk(L,2);case t.ViewMode.DualPageWithCover:return[[L[0]]].concat(t.chunk(L.slice(1),2));case t.ViewMode.SinglePage:default:return t.chunk(L,1)}}),[P,f]),H=function(){if(w.current){var e=R.current,t=C+1;t<e.length&&(C>=0&&e[C].setAttribute("tabindex","-1"),j(t))}},N=function(){if(w.current){var e=R.current,t=C-1;t>=0&&(C>=0&&e[C].setAttribute("tabindex","-1"),j(t))}},O=function(){C>=0&&C<x&&v(C)};t.useIsomorphicLayoutEffect((function(){var e=w.current;e&&(R.current=Array.from(e.querySelectorAll(".rpv-thumbnail__item")))}),[f]),a.useEffect((function(){var e=R.current;if(!(0===e.length||C<0||C>e.length)){var t=e[C];t.setAttribute("tabindex","0"),t.focus()}}),[C]),t.useIsomorphicLayoutEffect((function(){var e=w.current,t=R.current;if(!(!e||0===t.length||i<0||i>t.length)){var n=t[i].closest(".rpv-thumbnail__items");n&&(b===exports.ThumbnailDirection.Vertical?function(e,t){var n=e.getBoundingClientRect().top-t.getBoundingClientRect().top,i=e.clientHeight,a=t.clientHeight;n<0?t.scrollTop+=n:n+i<=a||(t.scrollTop+=n+i-a)}(n,e):function(e,t){var n=e.getBoundingClientRect().left-t.getBoundingClientRect().left,i=e.clientWidth,a=t.clientWidth;n<0?t.scrollLeft+=n:n+i<=a||(t.scrollLeft+=n+i-a)}(n,e))}}),[i,b]);var A=a.useCallback((function(e){T.current&&(k.markRendered(e),W.current=!1,q())}),[P]),z=a.useCallback((function(e,t){t.isVisible?k.setVisibility(e,t.ratio):k.setOutOfRange(e),q()}),[P]),q=a.useCallback((function(){if(!W.current){var e=k.getHighestPriorityPage();e>-1&&(k.markRendering(e),W.current=!0,D(e))}}),[P]);a.useEffect((function(){h>=0&&(k.markRendering(h),W.current=!0,D(h))}),[P,h]),t.useIsomorphicLayoutEffect((function(){y!==f&&(k.markNotRendered(),q())}),[f]);return e.jsx("div",{ref:w,"data-testid":"thumbnail__list",className:t.classNames({"rpv-thumbnail__list":!0,"rpv-thumbnail__list--horizontal":b===exports.ThumbnailDirection.Horizontal,"rpv-thumbnail__list--rtl":M,"rpv-thumbnail__list--vertical":b===exports.ThumbnailDirection.Vertical}),onKeyDown:function(e){switch(e.key){case"ArrowDown":H();break;case"ArrowUp":N();break;case"Enter":O()}},children:E.map((function(n,a){var h=!1;switch(f){case t.ViewMode.DualPage:h=i===2*a||i===2*a+1;break;case t.ViewMode.DualPageWithCover:h=0===i&&0===a||a>0&&i===2*a-1||a>0&&i===2*a;break;case t.ViewMode.SinglePage:default:h=i===a}return e.jsx("div",{className:t.classNames({"rpv-thumbnail__items":!0,"rpv-thumbnail__items--dual":f===t.ViewMode.DualPage,"rpv-thumbnail__items--dual-cover":f===t.ViewMode.DualPageWithCover,"rpv-thumbnail__items--single":f===t.ViewMode.SinglePage,"rpv-thumbnail__items--selected":h}),children:n.map((function(n){return function(n){var a=f===t.ViewMode.DualPageWithCover&&(0===n||x%2==0&&n===x-1),h="".concat(r.loadingTask.docId,"___").concat(n),b=o.length===x?o[n]:"".concat(n+1),P=l?l({currentPage:i,pageIndex:n,numPages:x,pageLabel:b}):b,w=u.has(n)?u.get(n):0,R=e.jsx(g,{doc:r,pageHeight:c,pageIndex:n,pageRotation:w,pageWidth:s,rotation:p,shouldRender:V===n,thumbnailWidth:m,onRenderCompleted:A,onVisibilityChanged:z});return d?d({currentPage:i,key:h,numPages:x,pageIndex:n,renderPageLabel:e.jsx(e.Fragment,{children:P}),renderPageThumbnail:R,onJumpToPage:function(){return v(n)},onRotatePage:function(e){return _(n,e)}}):e.jsxs("div",{children:[e.jsx("div",{className:t.classNames({"rpv-thumbnail__item":!0,"rpv-thumbnail__item--dual-even":f===t.ViewMode.DualPage&&n%2==0,"rpv-thumbnail__item--dual-odd":f===t.ViewMode.DualPage&&n%2==1,"rpv-thumbnail__item--dual-cover":a,"rpv-thumbnail__item--dual-cover-even":f===t.ViewMode.DualPageWithCover&&!a&&n%2==0,"rpv-thumbnail__item--dual-cover-odd":f===t.ViewMode.DualPageWithCover&&!a&&n%2==1,"rpv-thumbnail__item--single":f===t.ViewMode.SinglePage,"rpv-thumbnail__item--selected":i===n}),role:"button",tabIndex:i===n?0:-1,onClick:function(){return v(n)},children:R}),e.jsx("div",{"data-testid":"thumbnail__label-".concat(n),className:"rpv-thumbnail__label",children:P})]},h)}(n)}))},"".concat(a,"___").concat(f))}))})},p=function(n){var i=n.renderCurrentPageLabel,r=n.renderThumbnailItem,o=n.store,u=n.thumbnailDirection,c=n.thumbnailWidth,d=a.useState(o.get("doc")),g=d[0],p=d[1],b=a.useState(o.get("currentPage")||0),m=b[0],f=b[1],v=a.useState(o.get("pageHeight")||0),_=v[0],x=v[1],P=a.useState(o.get("pageWidth")||0),w=P[0],R=P[1],S=a.useState(o.get("rotation")||0),C=S[0],j=S[1],M=a.useState(o.get("pagesRotation")||new Map),I=M[0],V=M[1],D=a.useState(o.get("rotatedPage")||-1),T=D[0],y=D[1],W=a.useState(o.get("viewMode")),k=W[0],L=W[1],E=function(e){f(e)},H=function(e){p(e)},N=function(e){x(e)},O=function(e){R(e)},A=function(e){j(e)},z=function(e){V(e)},q=function(e){y(e)},B=function(e){L(e)},J=function(e){var t=o.get("jumpToPage");t&&t(e)},U=function(e,t){o.get("rotatePage")(e,t)};return a.useEffect((function(){return o.subscribe("doc",H),o.subscribe("pageHeight",N),o.subscribe("pageWidth",O),o.subscribe("rotatedPage",q),o.subscribe("rotation",A),o.subscribe("pagesRotation",z),o.subscribe("viewMode",B),function(){o.unsubscribe("doc",H),o.unsubscribe("pageHeight",N),o.unsubscribe("pageWidth",O),o.unsubscribe("rotatedPage",q),o.unsubscribe("rotation",A),o.unsubscribe("pagesRotation",z),o.unsubscribe("viewMode",B)}}),[]),t.useIsomorphicLayoutEffect((function(){return o.subscribe("currentPage",E),function(){o.unsubscribe("currentPage",E)}}),[]),g?e.jsx(t.LazyRender,{testId:"thumbnail__list-container",attrs:{className:"rpv-thumbnail__list-container"},children:e.jsx(l,{doc:g,children:function(t){return e.jsx(h,{currentPage:m,doc:g,labels:t,pagesRotation:I,pageHeight:_,pageWidth:w,renderCurrentPageLabel:i,renderThumbnailItem:r,rotatedPage:T,rotation:C,thumbnailDirection:u,thumbnailWidth:c,viewMode:k,onJumpToPage:J,onRotatePage:U})}})}):e.jsx("div",{"data-testid":"thumbnail-list__loader",className:"rpv-thumbnail__loader",children:a.useContext(s).renderSpinner()})};exports.thumbnailPlugin=function(n){var i=a.useMemo((function(){return t.createStore({rotatePage:function(){},viewMode:t.ViewMode.SinglePage})}),[]),o=a.useState(""),l=o[0],d=o[1];return{install:function(e){i.update("jumpToPage",e.jumpToPage),i.update("rotatePage",e.rotatePage)},onDocumentLoad:function(e){d(e.doc.loadingTask.docId),i.update("doc",e.doc)},onViewerStateChange:function(e){return i.update("currentPage",e.pageIndex),i.update("pagesRotation",e.pagesRotation),i.update("pageHeight",e.pageHeight),i.update("pageWidth",e.pageWidth),i.update("rotation",e.rotation),i.update("rotatedPage",e.rotatedPage),i.update("viewMode",e.viewMode),e},Cover:function(t){return e.jsx(u,r({},t,{renderSpinner:null==n?void 0:n.renderSpinner,store:i}))},Thumbnails:a.useCallback((function(t){return e.jsx(s.Provider,{value:{renderSpinner:(null==n?void 0:n.renderSpinner)||c},children:e.jsx(p,{renderCurrentPageLabel:null==n?void 0:n.renderCurrentPageLabel,renderThumbnailItem:null==t?void 0:t.renderThumbnailItem,store:i,thumbnailDirection:(null==t?void 0:t.thumbnailDirection)||exports.ThumbnailDirection.Vertical,thumbnailWidth:(null==n?void 0:n.thumbnailWidth)||100})})}),[l])}};
