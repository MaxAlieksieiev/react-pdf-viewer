"use strict";var e=require("react/jsx-runtime"),t=require("@react-pdf-viewer/core"),n=require("react"),i=require("is-mobile");function r(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var i=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,i.get?i:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var o,a=r(n);!function(e){e.NoSelection="NoSelection",e.Selecting="Selecting",e.Selected="Selected",e.Selection="Selection",e.ClickDragging="ClickDragging",e.ClickDragged="ClickDragged"}(o||(o={}));var c,s,h={height:0,left:0,pageIndex:-1,top:0,width:0},g={highlightAreas:[],selectionRegion:h,type:o.NoSelection},l={highlightAreas:[],selectionRegion:h,type:o.Selecting},u=function(t){var n=t.canvasLayerRef,r=t.canvasLayerRendered,c=t.pageIndex,s=t.store,h=t.textLayerRef,l=t.textLayerRendered,u=a.useRef(),d=a.useRef(document.body.style.cursor),f=a.useRef({x:0,y:0}),p=a.useRef({top:0,left:0}),v=function(){var e=u.current;e&&e.classList.add("rpv-highlight__click-drag--hidden")},x=function(e){console.log("hahandleMouseDownnde");var t=h.current,n=u.current;if(e.altKey&&t&&n&&!(e instanceof MouseEvent&&0!==e.button)){e.preventDefault(),document.body.style.cursor="crosshair";var i=t.getBoundingClientRect(),r={x:e instanceof MouseEvent?e.clientX:e.touches[0].clientX,y:e instanceof MouseEvent?e.clientY:e.touches[0].clientY};f.current=r;var a={top:100*(r.y-i.top)/i.height,left:100*(r.x-i.left)/i.width};p.current=a,n.style.top="".concat(a.top,"%"),n.style.left="".concat(a.left,"%"),n.style.height="0px",n.style.width="0px",e instanceof MouseEvent&&(document.addEventListener("mousemove",m),document.addEventListener("mouseup",S)),e instanceof TouchEvent&&(document.addEventListener("touchmove",m),document.addEventListener("touchend",S)),s.updateCurrentValue("highlightState",(function(e){return Object.assign({},e,{type:o.ClickDragging})}))}},m=function(e){console.log("handleDocumentMouseMove");var t=h.current,n=u.current;if(t&&n){e.preventDefault();var i=(e instanceof MouseEvent?e.clientX:e.touches[0].clientX)-f.current.x,r=(e instanceof MouseEvent?e.clientY:e.touches[0].clientY)-f.current.y,o=t.getBoundingClientRect();n.classList.contains("rpv-highlight__click-drag--hidden")&&n.classList.remove("rpv-highlight__click-drag--hidden");var a=Math.min(100-p.current.left,100*i/o.width),c=Math.min(100-p.current.top,100*r/o.height);n.style.width="".concat(a,"%"),n.style.height="".concat(c,"%")}},w=function(e){console.log("handleDocumentKeyDown"),"Escape"===e.key&&s.get("highlightState").type===o.ClickDragged&&(e.preventDefault(),v(),s.update("highlightState",g))},y=function(e){console.log("handleDocumenClick",y);var t=u.current;t&&(s.get("highlightState").type===o.NoSelection&&e.target!==t&&v())},S=function(e){console.log("handleDocumentMouseUp"),e.preventDefault(),e instanceof MouseEvent&&(document.removeEventListener("mousemove",m),document.removeEventListener("mouseup",S)),e instanceof TouchEvent&&(document.removeEventListener("touchmove",m),document.removeEventListener("touchend",S)),b();var t=u.current,i=n.current;if(t&&i){var r,a,h={pageIndex:c,top:parseFloat(t.style.top.slice(0,-1)),left:parseFloat(t.style.left.slice(0,-1)),height:parseFloat(t.style.height.slice(0,-1)),width:parseFloat(t.style.width.slice(0,-1))},g=(r=document.createElement("canvas"),a=window.devicePixelRatio||1,function(e,t){var n=e.getBoundingClientRect(),i=t.left*n.width/100,o=t.top*n.height/100,c=t.width*n.width/100,s=t.height*n.height/100,h=r.getContext("2d");return r.width=c,r.height=s,null==h||h.drawImage(e,i*a,o*a,c*a,s*a,0,0,c,s),r.toDataURL("image/png")})(i,h),l={highlightAreas:[h],previewImage:g,selectionRegion:h,type:o.ClickDragged};s.update("highlightState",l)}},b=function(){d.current?document.body.style.cursor=d.current:document.body.style.removeProperty("cursor")},E=function(e){(e.type===o.Selection||e.type===o.ClickDragging&&e.selectionRegion.pageIndex!==c)&&v()};return a.useEffect((function(){return s.subscribe("highlightState",E),function(){s.unsubscribe("highlightState",E)}}),[]),a.useEffect((function(){var e=n.current,t=h.current;if(r&&l&&e&&t){i()?t.addEventListener("touchstart",x):t.addEventListener("mousedown",x);var o={capture:!0};return i()?document.addEventListener("touchcancel",y,o):(document.addEventListener("keydown",w),document.addEventListener("click",y,o)),function(){i()?(t.removeEventListener("touchstart",x),document.removeEventListener("touchcancel",y,o)):(t.removeEventListener("mousedown",x),document.removeEventListener("click",y,o),document.removeEventListener("keydown",w))}}}),[l]),e.jsx("div",{ref:u,className:"rpv-highlight__click-drag rpv-highlight__click-drag--hidden"})},d=function(e){return e>=0?e:360+e},f=function(e,t){switch(d(t)){case 90:return{height:"".concat(e.width,"%"),position:"absolute",right:"".concat(e.top,"%"),top:"".concat(e.left,"%"),width:"".concat(e.height,"%")};case 180:return{bottom:"".concat(e.top,"%"),height:"".concat(e.height,"%"),position:"absolute",right:"".concat(e.left,"%"),width:"".concat(e.width,"%")};case 270:return{height:"".concat(e.width,"%"),position:"absolute",left:"".concat(e.top,"%"),bottom:"".concat(e.left,"%"),width:"".concat(e.height,"%")};default:return{height:"".concat(e.height,"%"),position:"absolute",top:"".concat(e.top,"%"),left:"".concat(e.left,"%"),width:"".concat(e.width,"%")}}},p=function(t){var n=t.area,i=t.rotation;return e.jsx("div",{className:"rpv-highlight__selected-text",style:f(n,i)})},v=function(e){var t=a.useState(e.get("rotation")||0),n=t[0],i=t[1],r=function(e){return i(e)};return a.useEffect((function(){return e.subscribe("rotation",r),function(){e.unsubscribe("rotation",r)}}),[]),{rotation:n}},x=function(t){var n=t.pageIndex,i=t.renderHighlightContent,r=t.renderHighlightTarget,c=t.renderHighlights,s=t.store,h=a.useState(s.get("highlightState")),l=h[0],u=h[1],d=v(s).rotation,x=function(e){return u(e)},m=function(){window.getSelection().removeAllRanges(),s.update("highlightState",g)};a.useEffect((function(){return s.subscribe("highlightState",x),function(){s.unsubscribe("highlightState",x)}}),[]);var w=l.type===o.Selection?l.highlightAreas.filter((function(e){return e.pageIndex===n})):[];return e.jsxs(e.Fragment,{children:[r&&(l.type===o.Selected||l.type===o.ClickDragged)&&l.selectionRegion.pageIndex===n&&r({highlightAreas:l.highlightAreas,previewImage:l.previewImage||"",selectedText:l.selectedText||"",selectionRegion:l.selectionRegion,selectionData:l.selectionData,cancel:m,toggle:function(){var e=Object.assign({},l,{type:o.Selection});s.update("highlightState",e),window.getSelection().removeAllRanges()}}),i&&l.type==o.Selection&&l.selectionRegion.pageIndex===n&&i({highlightAreas:l.highlightAreas,previewImage:l.previewImage||"",selectedText:l.selectedText||"",selectionRegion:l.selectionRegion,selectionData:l.selectionData,cancel:m}),w.length>0&&e.jsx("div",{children:w.map((function(t,n){return e.jsx(p,{area:t,rotation:d},n)}))}),c&&c({pageIndex:n,rotation:d,getCssProperties:f})]})},m="data-highlight-text-layer",w="data-highlight-text-page",y=function(e,t,n){var i=e.cloneNode(!0);e.parentNode.appendChild(i);var r=i.firstChild,o=new Range;o.setStart(r,t),o.setEnd(r,n);var a=document.createElement("span");o.surroundContents(a);var c=a.getBoundingClientRect();return i.parentNode.removeChild(i),c},S=function(e,t,n,i,r,o){if(n<r){var a=e.slice(n,n+1).map((function(e){return e.textContent.substring(i).trim()})).join(" "),c=e.slice(n+1,r).map((function(e){return e.textContent.trim()})).join(" "),s=e.slice(r,r+1).map((function(e){return e.textContent.substring(0,o||e.textContent.length)})).join(" "),h="".concat(a," ").concat(c," ").concat(s);return{divTexts:e.slice(n,r+1).map((function(e,i){return{divIndex:n+i,pageIndex:t,textContent:e.textContent}})),wholeText:h}}var g=e[n];h=g.textContent.substring(i,o||g.textContent.length).trim();return{divTexts:[{divIndex:n,pageIndex:t,textContent:g.textContent}],wholeText:h}};!function(e){e.SameDiv="SameDiv",e.DifferentDivs="DifferentDivs",e.DifferentPages="DifferentPages"}(c||(c={})),exports.Trigger=void 0,(s=exports.Trigger||(exports.Trigger={})).None="None",s.TextSelection="TextSelection";var b=["","\n"],E=function(t){var n=t.store,r=v(n).rotation,s=a.useRef(null),h=a.useState(!1),g=h[0],l=h[1],u=a.useState(n.get("trigger")),f=u[0],p=u[1],x=function(e){var t=e();s.current=t,l(!!t)},E=function(e){return p(e)},L=function(){var e=document.getSelection(),t=n.get("highlightState");if((t.type===o.NoSelection||t.type===o.Selected)&&e.rangeCount>0&&-1===b.indexOf(e.toString())){var i,a,s=e.getRangeAt(0),h=s.startContainer.parentNode,g=s.endContainer.parentNode,l=g instanceof HTMLElement&&g.hasAttribute(m);if(h&&h.parentNode==s.endContainer?a=(i=h).textContent.length:l&&0==s.endOffset?a=(i=s.endContainer.previousSibling).textContent.length:l?(i=s.endContainer,a=s.endOffset):(i=g,a=s.endOffset),h instanceof HTMLElement&&i instanceof HTMLElement){var u=parseInt(h.getAttribute(w),10),f=parseInt(i.getAttribute(w),10),p=h.parentElement,v=i.parentElement,x=p.getBoundingClientRect(),E=[].slice.call(p.querySelectorAll("[".concat(w,"]"))),L=E.indexOf(h),C=v.getBoundingClientRect(),D=[].slice.call(v.querySelectorAll("[".concat(w,"]"))),R=D.indexOf(i),I=s.startOffset,T=c.DifferentPages;switch(!0){case u===f&&L===R:T=c.SameDiv;break;case u===f&&L<R:T=c.DifferentDivs;break;default:T=c.DifferentPages}var j=function(e,t,n){return Array(t-e+1).fill(0).map((function(t,i){return n[e+i].getBoundingClientRect()}))},k=[];switch(T){case c.SameDiv:var M=y(h,I,a);k=[{height:100*M.height/x.height,left:100*(M.left-x.left)/x.width,pageIndex:u,top:100*(M.top-x.top)/x.height,width:100*M.width/x.width}];break;case c.DifferentDivs:k=[y(h,I,h.textContent.length)].concat(j(L+1,R-1,E)).concat([y(i,0,a)]).map((function(e){return{height:100*e.height/x.height,left:100*(e.left-x.left)/x.width,pageIndex:u,top:100*(e.top-x.top)/x.height,width:100*e.width/x.width}}));break;case c.DifferentPages:var A=[y(h,I,h.textContent.length)].concat(j(L+1,E.length-1,E)).map((function(e){return{height:100*e.height/x.height,left:100*(e.left-x.left)/x.width,pageIndex:u,top:100*(e.top-x.top)/x.height,width:100*e.width/x.width}})),P=j(0,R-1,D).concat([y(i,0,a)]).map((function(e){return{height:100*e.height/C.height,left:100*(e.left-C.left)/C.width,pageIndex:f,top:100*(e.top-C.top)/C.height,width:100*e.width/C.width}}));k=A.concat(P)}var O,N="",_=[];switch(T){case c.SameDiv:var H=S(E,u,L,I,L,a);N=H.wholeText,_=H.divTexts;break;case c.DifferentDivs:var q=S(E,u,L,I,R,a);N=q.wholeText,_=q.divTexts;break;case c.DifferentPages:var B=S(E,u,L,I,E.length),F=S(D,f,0,0,R,a);N="".concat(B.wholeText,"\n").concat(F.wholeText),_=B.divTexts.concat(F.divTexts)}if(k.length>0)O=k[k.length-1];else{var Y=i.getBoundingClientRect();O={height:100*Y.height/C.height,left:100*(Y.left-C.left)/C.width,pageIndex:f,top:100*(Y.top-C.top)/C.height,width:100*Y.width/C.width}}var X={divTexts:_,selectedText:N,startPageIndex:u,endPageIndex:f,startOffset:I,startDivIndex:L,endOffset:a,endDivIndex:R},V={type:o.Selected,selectedText:N,highlightAreas:k.map((function(e){return function(e,t){switch(d(t)){case 90:return{height:e.width,left:e.top,pageIndex:e.pageIndex,top:100-e.width-e.left,width:e.height};case 180:return{height:e.height,left:100-e.width-e.left,pageIndex:e.pageIndex,top:100-e.height-e.top,width:e.width};case 270:return{height:e.width,left:100-e.height-e.top,pageIndex:e.pageIndex,top:e.left,width:e.height};default:return e}}(e,r)})),selectionData:X,selectionRegion:O};n.update("highlightState",V)}}};return a.useEffect((function(){var e=s.current;if(e&&f!==exports.Trigger.None)return i()?e.addEventListener("touchend",L):e.addEventListener("mouseup",L),function(){i()?e.removeEventListener("touchend",L):e.removeEventListener("mouseup",L)}}),[g,f,r]),a.useEffect((function(){return n.subscribe("getPagesContainer",x),n.subscribe("trigger",E),function(){n.unsubscribe("getPagesContainer",x),n.unsubscribe("trigger",E)}}),[]),e.jsx(e.Fragment,{})},L="rpv-highlight__selected-end";exports.MessageIcon=function(){return e.jsxs(t.Icon,{size:16,children:[e.jsx("path",{d:"M23.5,17a1,1,0,0,1-1,1h-11l-4,4V18h-6a1,1,0,0,1-1-1V3a1,1,0,0,1,1-1h21a1,1,0,0,1,1,1Z"}),e.jsx("path",{d:"M5.5 12L18.5 12"}),e.jsx("path",{d:"M5.5 7L18.5 7"})]})},exports.highlightPlugin=function(n){var r=Object.assign({},{trigger:exports.Trigger.TextSelection},n),c=a.useMemo((function(){return t.createStore({highlightState:g,trigger:r.trigger})}),[]);return{install:function(e){c.update("jumpToDestination",e.jumpToDestination),c.update("getPagesContainer",e.getPagesContainer)},onViewerStateChange:function(e){return c.update("rotation",e.rotation),e},onTextLayerRender:function(e){var n,r=(n=e,function(e){if(!(c.get("trigger")===exports.Trigger.None||e instanceof MouseEvent&&0!==e.button)){var t=n.ele,i=t.getBoundingClientRect(),r=c.get("highlightState");if(r.type===o.Selected){var a=(e instanceof MouseEvent?e.clientY:e.touches[0].clientY)-i.top,s=(e instanceof MouseEvent?e.clientX:e.touches[0].clientX)-i.left;r.highlightAreas.filter((function(e){return e.pageIndex===n.pageIndex})).find((function(e){var t=e.top*i.height/100,n=e.left*i.width/100,r=e.height*i.height/100,o=e.width*i.width/100;return t<=a&&a<=t+r&&n<=s&&s<=n+o}))?(window.getSelection().removeAllRanges(),c.update("highlightState",g)):c.update("highlightState",l)}else c.update("highlightState",g);var h=100*((e instanceof MouseEvent?e.clientY:e.touches[0].clientY)-i.top)/i.height,u=t.querySelector(".".concat(L));u&&e.target!==t&&(u.style.top="".concat(Math.max(0,h),"%"))}}),a=function(e){return function(t){if(c.get("trigger")!==exports.Trigger.None){var n=e.ele.querySelector(".".concat(L));n&&n.style.removeProperty("top")}}}(e),s=e.ele;if(e.status===t.LayerRenderStatus.PreRender){i()?(s.removeEventListener("touchstart",r),s.removeEventListener("touchend",a)):(s.removeEventListener("mousedown",r),s.removeEventListener("mouseup",a));var h=s.querySelector(".".concat(L));h&&s.removeChild(h)}else if(e.status===t.LayerRenderStatus.DidRender&&(i()?(s.addEventListener("touchstart",r),s.addEventListener("touchend",a)):(s.addEventListener("mousedown",r),s.addEventListener("mouseup",a)),s.setAttribute(m,"true"),s.querySelectorAll(".rpv-core__text-layer-text").forEach((function(t){return t.setAttribute(w,"".concat(e.pageIndex))})),!s.querySelector(".".concat(L)))){var u=document.createElement("div");u.classList.add(L),u.classList.add("rpv-core__text-layer-text--not"),s.appendChild(u)}},renderPageLayer:function(t){return e.jsxs(e.Fragment,{children:[e.jsx(u,{canvasLayerRef:t.canvasLayerRef,canvasLayerRendered:t.canvasLayerRendered,pageIndex:t.pageIndex,store:c,textLayerRef:t.textLayerRef,textLayerRendered:t.textLayerRendered}),e.jsx(x,{pageIndex:t.pageIndex,renderHighlightContent:r.renderHighlightContent,renderHighlightTarget:r.renderHighlightTarget,renderHighlights:r.renderHighlights,store:c})]})},renderViewer:function(t){var n=t.slot;return n.subSlot&&n.subSlot.children&&(n.subSlot.children=e.jsxs(e.Fragment,{children:[e.jsx(E,{store:c}),n.subSlot.children]})),n},jumpToHighlightArea:function(e){var t=c.get("jumpToDestination");if(t){t({pageIndex:e.pageIndex,bottomOffset:function(t,n){return(100-e.top)*n/100},leftOffset:function(t,n){return(100-e.left)*t/100}})}},switchTrigger:function(e){c.update("trigger",e)}}};
